<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BFP Konekt Dashboard</title>
    <meta property="fb:app_id" content="1539208937059303">
    
    <!-- Add Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Add Leaflet Draw plugin for radius editing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Leaflet Control Geocoder (Search Bar) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <!-- Add QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Facebook SDK -->
    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '1539208937059303', // Your Facebook App ID
                cookie     : true,
                xfbml      : true,
                version    : 'v18.0'
            });
            
            FB.AppEvents.logPageView();   
            
            // Check login status when the page loads
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        };

        // Function to handle login status changes
        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                // User is logged in and has authenticated your app
                console.log('User is logged in and authenticated');
                
                // Store the access token securely
                const accessToken = response.authResponse.accessToken;
                const userId = response.authResponse.userID;
                
                // Store in sessionStorage (more secure than localStorage)
                sessionStorage.setItem('fb_access_token', accessToken);
                sessionStorage.setItem('fb_user_id', userId);
                
                // Set token expiration
                const expiresIn = response.authResponse.expiresIn;
                const tokenExpiry = new Date().getTime() + (expiresIn * 1000);
                sessionStorage.setItem('fb_token_expiry', tokenExpiry);
                
                // Update UI to show connected state
                updateConnectionStatus(true);
                
                // Get user profile and permissions
                getUserProfile();
                checkPermissions();

                // Hide the login button and show user info
                const loginButton = document.querySelector('.fb-login-button');
                if (loginButton) {
                    loginButton.style.display = 'none';
                }
            } else if (response.status === 'not_authorized') {
                // User is logged in but hasn't authorized your app
                console.log('User is logged in but not authorized');
                updateConnectionStatus(false);
                clearStoredTokens();
                
                // Show the login button
                const loginButton = document.querySelector('.fb-login-button');
                if (loginButton) {
                    loginButton.style.display = 'block';
                }
            } else {
                // User is not logged in
                console.log('User is not logged in');
                updateConnectionStatus(false);
                clearStoredTokens();
                
                // Show the login button
                const loginButton = document.querySelector('.fb-login-button');
                if (loginButton) {
                    loginButton.style.display = 'block';
                }
            }
        }

        // Function to clear stored tokens
        function clearStoredTokens() {
            sessionStorage.removeItem('fb_access_token');
            sessionStorage.removeItem('fb_user_id');
            sessionStorage.removeItem('fb_token_expiry');
        }

        // Function to update UI connection status
        function updateConnectionStatus(isConnected) {
            const systemApiStatus = document.getElementById('systemApiStatusValue');
            if (systemApiStatus) {
                if (isConnected) {
                    systemApiStatus.textContent = 'Connected';
                    systemApiStatus.style.color = 'var(--success)';
                } else {
                    systemApiStatus.textContent = 'Disconnected';
                    systemApiStatus.style.color = 'var(--danger)';
                }
            }
        }

        // Function to check if token is expired
        function isTokenExpired() {
            const expiry = sessionStorage.getItem('fb_token_expiry');
            if (!expiry) return true;
            return new Date().getTime() > parseInt(expiry);
        }

        // Function to check required permissions
        function checkPermissions() {
            FB.api('/me/permissions', function(response) {
                if (response && !response.error) {
                    const requiredPermissions = ['public_profile', 'pages_read_engagement', 'pages_show_list'];
                    const missingPermissions = requiredPermissions.filter(perm => 
                        !response.data.some(p => p.permission === perm && p.status === 'granted')
                    );
                    
                    if (missingPermissions.length > 0) {
                        console.log('Missing permissions:', missingPermissions);
                        // You might want to request missing permissions here
                        requestMissingPermissions(missingPermissions);
                    }
                }
            });
        }

        // Function to request missing permissions
        function requestMissingPermissions(permissions) {
            FB.login(function(response) {
                if (response.authResponse) {
                    console.log('Permissions granted');
                    checkPermissions(); // Check again after new permissions
                } else {
                    console.log('User cancelled login or did not fully authorize.');
                }
            }, {scope: permissions.join(',')});
        }

        // Function to get user profile information
        function getUserProfile() {
            FB.api('/me', {fields: 'name,email,picture'}, function(response) {
                if (response && !response.error) {
                    console.log('User profile:', response);
                    // Update UI with user information
                    updateUserProfileUI(response);
                }
            });
        }

        // Function to update UI with user profile
        function updateUserProfileUI(userData) {
            const profilePic = document.querySelector('.profile-pic img');
            const usernameDisplay = document.getElementById('adminUsernameDisplay');
            
            if (profilePic && userData.picture) {
                profilePic.src = userData.picture.data.url;
            }
            
            if (usernameDisplay) {
                usernameDisplay.textContent = userData.name;
            }
        }

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
    
    <!-- NLP Libraries -->
    <script src="https://unpkg.com/compromise"></script>
    <script src="https://cdn.jsdelivr.net/npm/natural@6.5.0/dist/natural.min.js"></script>
    
    <!-- Geocoding and Location Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/turf@3.0.14/turf.min.js"></script>
    
    <!-- Custom FB Scraper and NLP Module -->
    <script src="js/fb-scraper.js"></script>
    <script src="js/nlp-processor.js"></script>
    <script src="js/fb-scraper-config.js"></script>

    <!-- Facebook Authentication -->
    <script src="js/fb-auth-ui.js"></script>
    <script src="js/fb-auth-handler.js"></script>

    <style>
        :root {
            /* Primary Colors */
            --primary: #FF8C00;
            --primary-light: #FFB84D;
            --primary-dark: #E67A00;

            /* Secondary Colors */
            --secondary: #1A237E;
            --secondary-light: #534BAE;
            --secondary-dark: #000051;

            /* Background Colors */
            --bg-main: #F8F9FA;
            --bg-light: #FFFFFF;
            --bg-dark: #343A40;
            --sidebar-bg: #1A1A1A;

            /* Text Colors */
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --text-muted: #6C757D;

            /* Utility Colors */
            --shadow: rgba(0, 0, 0, 0.1);
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            display: flex;
            background: var(--bg-main);
            color: var(--text-dark);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            padding: 20px 0;
            position: fixed;
            height: 100%;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 99;
            box-shadow: 4px 0 15px var(--shadow);
        }

        .logo-container {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .logo-container img {
            max-width: 170px;
            max-height: 85px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .menu-items {
            padding: 0 15px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .menu-item i {
            margin-right: 15px;
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 0;
            background: var(--bg-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Dashboard Grid Layout */
        .dashboard-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 20px;
            padding: 0;
        }

        /* Panel Styling */
        .panel {
            background: var(--bg-light);
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .panel-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-light);
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Profile Section Styles Update */
        .profile-section {
            padding: 20px;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto;
            border: 3px solid var(--primary-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .profile-info p {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .badge {
            background: var(--danger);
            color: var(--text-light);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: fit-content;
        }

        .badge:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Form Controls */
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-light);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Map Styles */
        .map-container {
            padding: 20px;
            flex: 1;
            position: relative;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
        }

        #map {
            width: 100%;
            /* height: 100%; Removed as flex-grow will handle it */
            flex-grow: 1; /* Allow map to take available space in .map-container */
            min-height: 400px; /* Reduced min-height to prevent overflow, adjust as needed */
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }

        /* Content Body */
        .content-body {
            flex: 1;
            display: none;
            padding: 0;
        }

        .content-body.active,
        #dashboard-content {
            display: flex;
            flex-direction: column;
        }

        /* Content Header */
        .content-header {
            padding: 20px;
            margin: 0;
            border-bottom: none;
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary) 100%);
            color: var(--text-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 500;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .dashboard-panels {
                margin: 15px;
                gap: 15px;
            }

            .panel {
                margin-bottom: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        /* Incident Popup Styles */
        .incident-popup {
            padding: 10px;
            max-width: 300px;
        }

        .incident-popup h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .incident-popup p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .incident-popup .status-active {
            color: var(--danger);
            font-weight: bold;
        }

        .incident-popup .status-resolved {
            color: var(--success);
            font-weight: bold;
        }

        /* Marker Cluster Styles */
        .marker-cluster {
            background-color: rgba(255, 140, 0, 0.6);
        }

        .marker-cluster div {
            background-color: rgba(255, 140, 0, 0.8);
            color: var(--text-light);
        }

        /* Logo Settings Styles */
        .logo-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .logo-preview {
            text-align: center;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 10px;
        }

        .logo-preview h3 {
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .logo-preview img {
            max-width: 200px;
            max-height: 200px;
            width: auto;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .logo-info {
            margin-top: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .logo-upload {
            text-align: center;
        }

        .selected-file {
            margin-top: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .logo-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-secondary {
            background: var(--bg-dark);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        /* Keyword Management Styles */
        .keyword-management {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .keyword-input-area {
            display: flex;
            gap: 10px;
        }

        .keyword-input-area input {
            flex-grow: 1;
        }

        .keyword-list {
            list-style: none;
            padding: 0;
            max-height: 200px; /* Or any desired height */
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 10px;
        }

        .keyword-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .keyword-list li:last-child {
            border-bottom: none;
        }

        .keyword-list .btn-remove-keyword {
            background-color: var(--danger);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 5px;
        }
         .keyword-list .btn-remove-keyword:hover {
            background-color: var(--primary-dark); /* Or a darker shade of danger */
        }

        /* Add loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-left: 10px;
            border: 2px solid var(--text-light);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Add Footer Styles */
        .dashboard-footer {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            padding: 15px 20px;
            position: fixed;
            bottom: 0;
            right: 0;
            left: 240px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 15px var(--shadow);
            z-index: 98;
        }

        .footer-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .footer-item i {
            font-size: 1.1rem;
        }

        .bfp-brand {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-light);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .dashboard-footer {
                left: 0;
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .footer-section {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Styles for FB Auth in Sidebar */
        .profile-section #fbAuthSidebarContainer .fb-auth-container {
            padding: 10px 5px; /* More compact padding */
            margin: 15px 0 0 0; /* Margin above, aligned with profile items */
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .profile-section #fbAuthSidebarContainer .fb-login-btn {
            padding: 8px 12px; /* Smaller button */
            font-size: 0.85rem;
            width: 100%;
            justify-content: center;
        }

        .profile-section #fbAuthSidebarContainer .fb-status {
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 8px;
        }

        .profile-section #fbAuthSidebarContainer .fb-user-profile {
            flex-direction: column; /* Stack profile items vertically */
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }
        .profile-section #fbAuthSidebarContainer .fb-user-profile img {
            width: 30px;
            height: 30px;
        }
        .profile-section #fbAuthSidebarContainer .fb-logout-btn {
            padding: 5px 10px;
            font-size: 0.75rem;
            width: 80%;
            margin-top: 5px;
        }

        /* History Table Styles */
        .history-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between button and table */
        }

        #downloadHistoryBtn {
            align-self: flex-end; /* Position button to the right */
            margin-bottom: 15px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 8px var(--shadow);
            background-color: var(--bg-light);
            border-radius: 8px;
            overflow: hidden; /* Ensures border-radius is applied to table */
        }

        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--bg-main); /* Light line between rows */
        }

        .history-table thead th {
            background-color: var(--secondary-dark); /* Darker blue for header */
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .history-table tbody tr:last-child td {
            border-bottom: none;
        }

        .history-table tbody tr:hover {
            background-color: var(--bg-main); /* Slight hover effect */
        }

        .history-table .status-active {
            color: var(--danger);
            font-weight: bold;
        }

        .history-table .status-resolved {
            color: var(--success);
            font-weight: bold;
        }

        /* Active Incidents List Styles */
        #active-incidents-panel-body {
            padding: 0; /* Remove default panel-body padding if list items have their own */
        }
        .incident-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px; /* Adjust as needed, provides scroll for many items */
            overflow-y: auto;
        }

        .incident-list li {
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-main); /* Similar to table rows */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out;
        }
        .incident-list li:hover {
            background-color: var(--bg-main);
        }

        .incident-list li:last-child {
            border-bottom: none;
        }

        .incident-list .incident-info {
            flex-grow: 1;
            margin-right: 10px;
        }
        .incident-list .incident-location {
            font-weight: 500;
            display: block;
            color: var(--text-dark);
            margin-bottom: 3px;
        }
        .incident-list .incident-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
        }

        .incident-list .btn-resolve {
            background-color: var(--success);
            color: white;
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            white-space: nowrap; /* Prevent button text from wrapping */
            transition: background-color 0.2s ease-in-out;
        }
        .incident-list .btn-resolve:hover {
            background-color: #218838; /* Darker success green */
        }
        .incident-list .no-active-incidents {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
            border-bottom: none; /* No border if it's the only item */
        }
        .incident-list .no-active-incidents:hover {
            background-color: transparent; /* No hover effect for this item */
        }

        /* Loading Screen Styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* background-color: rgba(255, 255, 255, 0.95); Removed for full image background */
            background-image: url('bfp-anime-landscape.png'); /* Added */
            background-size: cover; /* Added */
            background-position: center; /* Added */
            background-repeat: no-repeat; /* Added */
            z-index: 20000; /* Ensure it's above everything */
            display: flex; /* Use flexbox for centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* #loadingOverlay img { Removed as image is now a background for the overlay div 
            max-width: 60%; 
            max-height: 60vh; 
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        } */
        #loadingOverlay p {
            font-size: 2em; /* Slightly increased font size */
            color: white; /* Changed to white for better contrast */
            font-weight: 600;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8); /* Enhanced text shadow */
            margin-bottom: 20px; /* Added margin to separate from spinner */
        }
        /* Optional: Add a spinner */
        .loader-spinner {
            border: 5px solid var(--bg-main, #f3f3f3); /* Light grey */
            border-top: 5px solid var(--primary, #FF8C00); /* Orange */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen Overlay -->
    <div id="loadingOverlay" style="display: none;">
        <!-- <img src="bfp-anime-landscape.png" alt="Loading BFPKonekt..."> Removed img tag -->
        <p>Loading Dashboard...</p>
        <div class="loader-spinner"></div> <!-- Optional spinner -->
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <a href="https://www.facebook.com/profile.php?id=100069248977961" target="_blank" style="text-decoration: none; display: block;">
                <img src="images/bfp-logo.png" alt="BFP Logo" style="cursor: pointer;">
            </a>
        </div>
        <div class="menu-items">
            <a class="menu-item active" data-page="dashboard">
                <i>üë§</i>
                <span>DASHBOARD</span>
            </a>
            <a class="menu-item" data-page="map">
                <i>üó∫Ô∏è</i>
                <span>MAP</span>
            </a>
            <a class="menu-item" data-page="settings">
                <i>‚öôÔ∏è</i>
                <span>SETTINGS</span>
            </a>
            <a class="menu-item" data-page="history">
                <i>üìú</i>
                <span>HISTORY</span>
            </a>
        </div>
        <div class="profile-section">
            <div class="profile-pic">
                <img src="logo.png" alt="BFP Logo">
            </div>
            <div class="profile-info">
                <p id="adminUsernameDisplay">BFPDASMA0001</p>
                <button class="badge" onclick="window.location.href='login.html'">LOGOUT</button>
                <div id="fbAuthSidebarContainer">
                    <fb:login-button 
                        scope="public_profile,email,pages_read_engagement,pages_show_list"
                        onlogin="checkLoginState();"
                        data-size="large"
                        data-button-type="login_with"
                        data-layout="default"
                        data-auto-logout-link="true"
                        data-use-continue-as="true">
                    </fb:login-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Content -->
        <div id="dashboard-content" class="content-body">
            <h1 class="content-header">Dashboard</h1>
            <div class="dashboard-panels">
                <!-- Quick Stats Panel -->
                <div class="panel">
                    <div class="panel-header">Quick Stats</div>
                    <div class="panel-body">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div id="activeCasesValue" class="stat-value">0</div>
                                <div class="stat-label">Active Cases</div>
                            </div>
                            <div class="stat-item">
                                <div id="totalReportsValue" class="stat-value">0</div>
                                <div class="stat-label">Total Reports (Session)</div>
                            </div>
                            <div class="stat-item">
                                <div id="responseRateValue" class="stat-value">0%</div>
                                <div class="stat-label">Response Rate (Session)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Incidents Panel -->
                <div class="panel">
                    <div class="panel-header">Active Incidents</div>
                    <div class="panel-body" id="active-incidents-panel-body">
                        <ul id="activeIncidentsList" class="incident-list">
                            <!-- Active incidents will be populated here by JavaScript -->
                            <li class="no-active-incidents">No active incidents at the moment.</li>
                        </ul>
                    </div>
                </div>

                <!-- System Status Panel -->
                <div class="panel">
                    <div class="panel-header">System Status</div>
                    <div class="panel-body">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div id="systemApiStatusValue" class="stat-value" style="color: var(--warning);">Connecting...</div>
                                <div class="stat-label">API Status</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">Online</div>
                                <div class="stat-label">Status</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">5 min</div>
                                <div class="stat-label">Update Interval</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">Good</div>
                                <div class="stat-label">Connection</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Content -->
        <div id="map-content" class="content-body">
            <h1 class="content-header">Map View</h1>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Settings Content -->
        <div id="settings-content" class="content-body">
            <h1 class="content-header">Settings</h1>
            <div class="dashboard-panels">
                <!-- Logo Settings Panel -->
                <div class="panel">
                    <div class="panel-header">Logo Settings</div>
                    <div class="panel-body">
                        <div class="logo-settings">
                            <div class="logo-preview">
                                <h3>Current Logo</h3>
                                <img id="currentLogo" src="images/bfp-logo.png" alt="Current Logo">
                                <p class="logo-info">Recommended size: 200x200px</p>
                            </div>
                            <div class="logo-upload">
                                <label for="logoFile" class="btn btn-primary">Choose New Logo</label>
                                <input type="file" id="logoFile" accept="image/*" style="display: none;">
                                <p id="selectedFileName" class="selected-file"></p>
                            </div>
                            <div class="logo-actions">
                                <button id="uploadLogo" class="btn btn-primary" disabled>Upload Logo</button>
                                <button id="resetLogo" class="btn btn-secondary">Reset to Default</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keyword Management Panel -->
                <div class="panel">
                    <div class="panel-header">Keyword Management</div>
                    <div class="panel-body">
                        <div class="keyword-management">
                            <p>Add keywords that the system will use to identify relevant Facebook posts.</p>
                            <div class="keyword-input-area">
                                <input type="text" id="keywordInput" class="form-control" placeholder="Enter keyword (e.g., sunog, fire)">
                                <button id="addKeywordBtn" class="btn btn-primary">Add</button>
                            </div>
                            <h4>Current Keywords:</h4>
                            <ul id="keywordList" class="keyword-list">
                                <!-- Keywords will be populated here by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- System Settings Panel -->
                <div class="panel">
                    <div class="panel-header">System Settings</div>
                    <div class="panel-body">
                        <div class="settings-grid">
                            <div class="form-group">
                                <label>Update Interval</label>
                                <select class="form-control">
                                    <option>5 minutes</option>
                                    <option>10 minutes</option>
                                    <option>15 minutes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notification Sound</label>
                                <select class="form-control">
                                    <option>Enabled</option>
                                    <option>Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Content -->
        <div id="history-content" class="content-body">
            <h1 class="content-header">Incident History (Current Session)</h1>
            <div class="history-container">
                <button id="downloadHistoryBtn" class="btn btn-primary">Download History (CSV)</button>
                <div style="overflow-x: auto;"> <!-- For responsiveness on small screens -->
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Location</th>
                                <th>Message Snippet</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- History items will be populated here by JavaScript -->
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 20px;">No incidents reported in this session yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="dashboard-footer">
        <div class="footer-section">
            <div class="footer-item">
                <i>üìÖ</i>
                <span id="currentDate">Loading date...</span>
            </div>
            <div class="footer-item">
                <i>‚è∞</i>
                <span id="currentTime">Loading time...</span>
            </div>
        </div>
        <div class="footer-section">
            <div class="bfp-brand">BUREAU OF FIRE PROTECTION</div>
        </div>
        <div class="footer-section">
            <div class="footer-item">
                <i>üìç</i>
                <span id="currentLocation">Fetching location...</span>
            </div>
        </div>
    </div>

    <script>
        // Map markers and data management
        let map;
        let markers = new Map();
        let markerCluster;
        let liveIncidentsData = new Map(); // Stores {id, message, location, currentStatus, ...}
        let dashboardReportStats = {
            totalReportedThisSession: 0,
            activeCases: 0
        };

        // --- START: BFP LANDMARK DATA ---
        // IMPORTANT: Replace with actual BFP station names and coordinates
        const bfpLandmarks = [
            { name: "BFP Dasmari√±as City Main Station", lat: 14.3285, lng: 120.9370, address: "Aguinaldo Highway, Dasmari√±as, Cavite" },
            { name: "BFP Salawag Sub-Station", lat: 14.2900, lng: 120.9700, address: "Salawag, Dasmari√±as, Cavite" },
            { name: "BFP Paliparan Sub-Station", lat: 14.3000, lng: 120.9900, address: "Paliparan, Dasmari√±as, Cavite" }
            // Add more BFP stations here as needed
        ];
        // --- END: BFP LANDMARK DATA ---

        // Function to update quick stats display
        function updateQuickStatsDisplay() {
            const activeCasesEl = document.getElementById('activeCasesValue');
            const totalReportsEl = document.getElementById('totalReportsValue');
            const responseRateEl = document.getElementById('responseRateValue');

            if (activeCasesEl) activeCasesEl.textContent = dashboardReportStats.activeCases;
            if (totalReportsEl) totalReportsEl.textContent = dashboardReportStats.totalReportedThisSession;

            let responseRate = 0;
            if (dashboardReportStats.totalReportedThisSession > 0) {
                const resolvedCases = dashboardReportStats.totalReportedThisSession - dashboardReportStats.activeCases;
                responseRate = (resolvedCases / dashboardReportStats.totalReportedThisSession) * 100;
            }
            if (responseRateEl) responseRateEl.textContent = responseRate.toFixed(0) + '%';
        }

        // Function to update API Status display in System Status panel
        function updateApiStatusDisplay(statusText, statusColor = 'var(--text-dark)') {
            const apiStatusEl = document.getElementById('systemApiStatusValue');
            if (apiStatusEl) {
                apiStatusEl.textContent = statusText;
                apiStatusEl.style.color = statusColor;
            }
        }

        // Initialize map with incident markers
        function initMap() {
            map = L.map('map').setView([14.3294, 120.9367], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker cluster group for dynamic incidents
            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);

            // --- START: Add BFP Landmarks to Map ---
            bfpLandmarks.forEach(landmark => {
                // For a more distinct look, you can use a custom icon for BFP stations.
                // Create an L.icon object and pass it in the marker options: { icon: bfpStationIcon }
                // Example custom icon definition (place this outside the loop if using the same icon for all):
                // const bfpStationIcon = L.icon({
                //     iconUrl: 'images/bfp_station_icon.png', // Ensure you have this image
                //     iconSize: [30, 30], // Adjust size as needed
                //     iconAnchor: [15, 30],   // Point of the icon which will correspond to marker's location
                //     popupAnchor: [0, -30] // Point from which the popup should open relative to the iconAnchor
                // });

                const landmarkMarker = L.marker([landmark.lat, landmark.lng]) // Add { icon: bfpStationIcon } here if using custom icon
                    .addTo(map) // Add directly to map, not markerCluster
                    .bindPopup(`<b>${landmark.name}</b><br>${landmark.address || 'Address not available'}`);
            });
            // --- END: Add BFP Landmarks to Map ---

            // --- START: Add Geocoder Search Control ---
            L.Control.geocoder({
                defaultMarkGeocode: true, // Automatically add a marker for the result
                geocoder: L.Control.Geocoder.nominatim(), // Use Nominatim for geocoding
                placeholder: 'Search for a location...', 
                errorMessage: 'Nothing found.'
            })
            .on('markgeocode', function(e) {
                // When a geocode result is marked (marker added)
                if (e.geocode && e.geocode.center) {
                    map.setView(e.geocode.center, 15); // Center map and zoom in
                }
            })
            .addTo(map);
            // --- END: Add Geocoder Search Control ---
        }

        // Convert address to coordinates using Nominatim
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Function to render the active incidents list on the dashboard
        function renderActiveIncidentsList() {
            const listElement = document.getElementById('activeIncidentsList');
            if (!listElement) return;

            listElement.innerHTML = ''; // Clear existing list

            const activeIncidents = Array.from(liveIncidentsData.values()).filter(inc => inc.currentStatus === 'active');

            if (activeIncidents.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'no-active-incidents';
                listItem.textContent = 'No active incidents at the moment.';
                listElement.appendChild(listItem);
                return;
            }

            activeIncidents.sort((a, b) => b.timestamp - a.timestamp); // Show newest first

            activeIncidents.forEach(incident => {
                const listItem = document.createElement('li');

                const infoDiv = document.createElement('div');
                infoDiv.className = 'incident-info';

                const locationSpan = document.createElement('span');
                locationSpan.className = 'incident-location';
                locationSpan.textContent = incident.location || 'Unknown Location';
                infoDiv.appendChild(locationSpan);

                const timeSpan = document.createElement('span');
                timeSpan.className = 'incident-time';
                timeSpan.textContent = `Reported: ${new Date(incident.timestamp).toLocaleString()}`;
                infoDiv.appendChild(timeSpan);

                listItem.appendChild(infoDiv);

                const resolveButton = document.createElement('button');
                resolveButton.className = 'btn-resolve'; // Use specific class from new CSS
                resolveButton.textContent = 'Mark Resolved';
                resolveButton.onclick = () => {
                    updateIncidentStatus(incident.id, 'resolved');
                };
                listItem.appendChild(resolveButton);

                listElement.appendChild(listItem);
            });
        }

        // Add incident marker to map
        async function addIncidentMarker(incident) {
            try {
                const coords = await geocodeAddress(incident.location);
                if (!coords) return;

                // Manage live incident data for stats
                if (!liveIncidentsData.has(incident.id)) {
                    const newIncidentEntry = { ...incident, currentStatus: 'active' };
                    liveIncidentsData.set(incident.id, newIncidentEntry);
                    dashboardReportStats.totalReportedThisSession++;
                    dashboardReportStats.activeCases++;
                    updateQuickStatsDisplay();
                    renderHistoryTable(); // Update history table
                    renderActiveIncidentsList(); // Update active incidents list
                }
                const incidentEntry = liveIncidentsData.get(incident.id);

                // Create marker with custom popup
                const marker = L.marker([coords.lat, coords.lng]);
                const popupContent = `
                    <div class="incident-popup">
                        <h3>Fire Incident</h3>
                        <p><strong>Location:</strong> ${incident.location}</p>
                        <p><strong>Reported by:</strong> ${incident.source}</p>
                        <p><strong>Time:</strong> ${new Date(incident.timestamp).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="incident-status-text ${incidentEntry.currentStatus === 'active' ? 'status-active' : 'status-resolved'}">${incidentEntry.currentStatus === 'active' ? 'Active' : 'Resolved'}</span></p>
                        <p><strong>Details:</strong> ${incident.message}</p>
                        ${incidentEntry.currentStatus === 'active' ? `<button onclick="updateIncidentStatus('${incident.id}', 'resolved')">Mark Resolved</button>` : `<button onclick="updateIncidentStatus('${incident.id}', 'active')">Mark Active</button>`}
                        <button onclick="removeIncident('${incident.id}')">Remove Incident</button>
                    </div>
                `;
                marker.bindPopup(popupContent);
                
                // Add to marker cluster
                markerCluster.addLayer(marker);
                markers.set(incident.id, marker);

                // Center map on new incident
                map.setView([coords.lat, coords.lng], 15);
            } catch (error) {
                console.error('Error adding marker:', error);
            }
        }

        // Remove incident marker from map
        function removeIncidentMarker(incidentId) {
            const marker = markers.get(incidentId);
            if (marker) {
                markerCluster.removeLayer(marker);
                markers.delete(incidentId);
            }
        }

        // New function to handle full incident removal including stats
        function removeIncident(incidentId) {
            const incidentEntry = liveIncidentsData.get(incidentId);
            if (incidentEntry) {
                if (incidentEntry.currentStatus === 'active') {
                    dashboardReportStats.activeCases--;
                }
                liveIncidentsData.delete(incidentId);
                updateQuickStatsDisplay();
                renderHistoryTable(); // Update history table
                renderActiveIncidentsList(); // Update active incidents list
            }
            removeIncidentMarker(incidentId); // Removes from map
            // Close any open popup for this marker if needed, though Leaflet might handle this.
            map.closePopup();
        }

        // Update incident marker status
        function updateIncidentStatus(incidentId, newStatus) {
            const marker = markers.get(incidentId);
            const incidentEntry = liveIncidentsData.get(incidentId);

            if (marker && incidentEntry) {
                const oldStatus = incidentEntry.currentStatus;
                incidentEntry.currentStatus = newStatus;

                if (oldStatus === 'active' && newStatus !== 'active') {
                    dashboardReportStats.activeCases--;
                } else if (oldStatus !== 'active' && newStatus === 'active') {
                    dashboardReportStats.activeCases++;
                }
                updateQuickStatsDisplay();
                renderHistoryTable(); // Update history table
                renderActiveIncidentsList(); // Update active incidents list

                // Update popup content dynamically
                const popup = marker.getPopup();
                if (popup) {
                    // Regenerate popup content to reflect new status and button
                     const newPopupContent = `
                        <div class="incident-popup">
                            <h3>Fire Incident</h3>
                            <p><strong>Location:</strong> ${incidentEntry.location}</p>
                            <p><strong>Reported by:</strong> ${incidentEntry.source}</p>
                            <p><strong>Time:</strong> ${new Date(incidentEntry.timestamp).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span class="incident-status-text ${incidentEntry.currentStatus === 'active' ? 'status-active' : 'status-resolved'}">${incidentEntry.currentStatus === 'active' ? 'Active' : 'Resolved'}</span></p>
                            <p><strong>Details:</strong> ${incidentEntry.message}</p>
                            ${incidentEntry.currentStatus === 'active' ? `<button onclick="updateIncidentStatus('${incidentEntry.id}', 'resolved')">Mark Resolved</button>` : `<button onclick="updateIncidentStatus('${incidentEntry.id}', 'active')">Mark Active</button>`}
                            <button onclick="removeIncident('${incidentEntry.id}')">Remove Incident</button>
                        </div>
                    `;
                    popup.setContent(newPopupContent);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize map
                initMap();
                updateQuickStatsDisplay(); // Initialize stats display
                updateApiStatusDisplay('Initializing...', 'var(--warning)'); // Initial API status
                renderHistoryTable(); // Initial render of history table
                renderActiveIncidentsList(); // Initial render of active incidents list

                // Initialize the Facebook scraper with configuration
                const initialKeywords = getKeywords(); // Get keywords from localStorage
                const scraper = new FacebookScraper(FB_CONFIG);
                
                // Add event listener for new posts
                scraper.addEventListener((posts) => {
                    // Handle new posts here
                    posts.forEach(post => {
                        console.log('New post:', post);
                    });
                });
                
                // Initialize the scraper
                await scraper.init();
                
                // Listen for API status updates from the scraper
                scraper.addEventListener('scraperApiStatusUpdate', (event) => {
                    const { status, color } = event.detail;
                    updateApiStatusDisplay(status, color);
                });
                
                await scraper.initialize();
                
                // Start scraping every 5 minutes
                setInterval(() => scraper.scrapePages(), 300000);
                
                // Listen for fire incident events
                scraper.addEventListener('fireIncidentFound', (event) => {
                    const { pageName, message, timestamp, location, confidence } = event.detail;
                    
                    // Create notification
                    createNotification('Fire Incident Detected', 
                        `New incident reported by ${pageName}\nLocation: ${location}\nConfidence: ${confidence}%`,
                        'warning');

                    // Add incident to map
                    const incident = {
                        id: Date.now(), // Unique ID for the incident
                        source: pageName,
                        message: message,
                        timestamp: timestamp,
                        location: location,
                        confidence: confidence
                    };
                    addIncidentMarker(incident);
                });
                
                console.log('Facebook scraper and map initialized successfully');
            } catch (error) {
                console.error('Failed to initialize:', error);
                createNotification('Error', 'Failed to initialize system', 'error');
            }
        });

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = {
                'dashboard': document.getElementById('dashboard-content'),
                'map': document.getElementById('map-content'),
                'settings': document.getElementById('settings-content'),
                'history': document.getElementById('history-content')
            };

            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all menu items
                    menuItems.forEach(i => i.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Show selected content
                    const pageId = this.getAttribute('data-page');
                    Object.values(contentSections).forEach(section => {
                        if (section) {
                            section.style.display = 'none';
                        }
                    });
                    
                    const activeSection = contentSections[pageId];
                    if (activeSection) {
                        activeSection.style.display = 'block';
                        
                        // Refresh map when map tab is selected
                        if (pageId === 'map' && map) {
                            map.invalidateSize();
                        }
                    }
                });
            });
        });

        // Logo handling functionality
        document.addEventListener('DOMContentLoaded', function() {
            const logoFile = document.getElementById('logoFile');
            const currentLogo = document.getElementById('currentLogo');
            const uploadBtn = document.getElementById('uploadLogo');
            const resetBtn = document.getElementById('resetLogo');
            const selectedFileName = document.getElementById('selectedFileName');
            const defaultLogoPath = 'images/bfp-logo.png';

            // Load saved logo from localStorage if exists
            const savedLogo = localStorage.getItem('customLogo');
            if (savedLogo) {
                currentLogo.src = savedLogo;
                document.querySelector('.sidebar .logo-container img').src = savedLogo;
            }

            // Handle file selection
            logoFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5242880) { // 5MB limit
                        createNotification('Error', 'File size should not exceed 5MB', 'error');
                        logoFile.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Create an image to check dimensions
                        const img = new Image();
                        img.onload = function() {
                            if (img.width > 1000 || img.height > 1000) {
                                createNotification('Error', 'Image dimensions should not exceed 1000x1000 pixels', 'error');
                                logoFile.value = '';
                                return;
                            }
                            // Preview the image
                            currentLogo.src = e.target.result;
                            uploadBtn.disabled = false;
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    selectedFileName.textContent = file.name;
                }
            });

            // Handle logo upload
            uploadBtn.addEventListener('click', function() {
                uploadBtn.classList.add('loading');
                uploadBtn.disabled = true;

                // Simulate upload delay
                setTimeout(() => {
                    const newLogoSrc = currentLogo.src;
                    // Save to localStorage
                    localStorage.setItem('customLogo', newLogoSrc);
                    // Update sidebar logo
                    document.querySelector('.sidebar .logo-container img').src = newLogoSrc;

                    uploadBtn.classList.remove('loading');
                    createNotification('Success', 'Logo updated successfully', 'success');
                    selectedFileName.textContent = '';
                    logoFile.value = '';
                }, 1000);
            });

            // Handle reset to default
            resetBtn.addEventListener('click', function() {
                // Reset to default logo
                currentLogo.src = defaultLogoPath;
                document.querySelector('.sidebar .logo-container img').src = defaultLogoPath;
                // Clear localStorage
                localStorage.removeItem('customLogo');
                // Reset file input
                logoFile.value = '';
                selectedFileName.textContent = '';
                uploadBtn.disabled = true;
                createNotification('Success', 'Logo reset to default', 'success');
            });
        });

        // Update time and date
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOptions);
        }

        // Update location
        async function updateLocation() {
            const locationElement = document.getElementById('currentLocation');
            if (!locationElement) return;

            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
                    });
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Perform reverse geocoding
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=en`);
                    if (!response.ok) {
                        throw new Error(`Nominatim API error: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data && data.display_name) {
                        let friendlyAddress = data.display_name;
                        // Attempt to create a more concise address
                        if (data.address) {
                            const city = data.address.city || data.address.town || data.address.village;
                            const state = data.address.state || data.address.county;
                            const country = data.address.country;

                            if (city && country) {
                                friendlyAddress = `${city}, ${country}`;
                            } else if (state && country) {
                                friendlyAddress = `${state}, ${country}`;
                            } else if (city && state) {
                                friendlyAddress = `${city}, ${state}`;
                            } // Add more combinations as needed or stick to display_name
                        }
                        locationElement.textContent = friendlyAddress;
                    } else {
                        locationElement.textContent = 'Address not found';
                    }
                } catch (error) {
                    locationElement.textContent = 'Location unavailable';
                    console.warn('Geolocation or Reverse Geocoding error:', error.message);
                }
            } else {
                locationElement.textContent = 'Geolocation not supported';
            }
        }

        // Initialize and update time/date/location
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            updateLocation();
            
            // Update time every second
            setInterval(updateDateTime, 1000);
            
            // Update location every 5 minutes
            setInterval(updateLocation, 300000);

            // Initialize Keyword Management
            initKeywordManagement();
        });

        // Initialize Facebook Authentication
        const fbAuth = new FacebookAuthHandler({
            appId: 'YOUR_APP_ID' // Replace with your Facebook App ID
        });

        // Initialize and mount the Facebook auth UI
        document.addEventListener('DOMContentLoaded', async () => {
            await fbAuth.initialize('#fbAuthSidebarContainer');
            renderHistoryTable(); // Also call here to ensure table is rendered after potential early data hydration (if any)

            // Override the onConnected method to handle post-connection logic
            fbAuth.onConnected = () => {
                // Refresh the dashboard or update necessary components
                console.log('Facebook connected, updating dashboard...');
                // Add your post-connection logic here
            };
        });

        // Keyword Management Functionality
        function initKeywordManagement() {
            const keywordInput = document.getElementById('keywordInput');
            const addKeywordBtn = document.getElementById('addKeywordBtn');
            const keywordList = document.getElementById('keywordList');
            const defaultKeywords = ['sunog', 'fire', 'nasusunog', 'fire alert']; // Default keywords

            let keywords = JSON.parse(localStorage.getItem('bfpKeywords')) || [...defaultKeywords];

            function renderKeywords() {
                keywordList.innerHTML = ''; // Clear existing list
                if (keywords.length === 0) {
                    const placeholderItem = document.createElement('li');
                    placeholderItem.textContent = 'No keywords added. Using defaults.';
                    placeholderItem.style.color = 'var(--text-muted)';
                    keywordList.appendChild(placeholderItem);
                } else {
                    keywords.forEach((keyword, index) => {
                        const listItem = document.createElement('li');
                        listItem.textContent = keyword;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Remove';
                        removeBtn.className = 'btn btn-remove-keyword';
                        removeBtn.onclick = () => {
                            removeKeyword(index);
                        };
                        listItem.appendChild(removeBtn);
                        keywordList.appendChild(listItem);
                    });
                }
            }

            function addKeyword() {
                const newKeyword = keywordInput.value.trim().toLowerCase();
                if (newKeyword && !keywords.includes(newKeyword)) {
                    keywords.push(newKeyword);
                    localStorage.setItem('bfpKeywords', JSON.stringify(keywords));
                    renderKeywords();
                    keywordInput.value = ''; // Clear input
                    createNotification('Success', `Keyword "${newKeyword}" added.`, 'success');
                    // Potentially re-initialize or notify the scraper
                    updateScraperKeywords();
                } else if (keywords.includes(newKeyword)) {
                    createNotification('Info', `Keyword "${newKeyword}" already exists.`, 'info');
                } else {
                    createNotification('Error', 'Please enter a valid keyword.', 'error');
                }
            }

            function removeKeyword(index) {
                const removedKeyword = keywords.splice(index, 1)[0];
                localStorage.setItem('bfpKeywords', JSON.stringify(keywords));
                renderKeywords();
                createNotification('Success', `Keyword "${removedKeyword}" removed.`, 'success');
                 // Potentially re-initialize or notify the scraper
                updateScraperKeywords();
            }
            
            addKeywordBtn.addEventListener('click', addKeyword);
            keywordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    addKeyword();
                }
            });

            // Initial render
            renderKeywords();
        }
        
        function getKeywords() {
            return JSON.parse(localStorage.getItem('bfpKeywords')) || ['sunog', 'fire', 'nasusunog', 'fire alert'];
        }

        function updateScraperKeywords() {
            if (scraper) {
                 scraper.updateKeywords(getKeywords());
                 console.log('Scraper keywords updated.');
            }
        }

        function createNotification(title, message, type = 'info') {
            // Simple notification function - consider a more robust library for production
            const notificationArea = document.getElementById('notificationArea') || createNotificationArea();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
            
            notificationArea.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function createNotificationArea() {
            let area = document.getElementById('notificationArea');
            if (!area) {
                area = document.createElement('div');
                area.id = 'notificationArea';
                area.style.position = 'fixed';
                area.style.top = '20px';
                area.style.right = '20px';
                area.style.zIndex = '10000';
                area.style.display = 'flex';
                area.style.flexDirection = 'column';
                area.style.gap = '10px';
                document.body.appendChild(area);
            }
            
            // Add basic styling for notifications if not already present
            if (!document.getElementById('notificationStyles')) {
                const styles = `
                    .notification {
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        color: #fff;
                        min-width: 250px;
                        transition: opacity 0.5s ease-in-out;
                    }
                    .notification strong { display: block; margin-bottom: 5px; }
                    .notification-info { background-color: var(--info); }
                    .notification-success { background-color: var(--success); }
                    .notification-warning { background-color: var(--warning); color: var(--text-dark); }
                    .notification-error { background-color: var(--danger); }
                `;
                const styleSheet = document.createElement('style');
                styleSheet.id = 'notificationStyles';
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);
            }
            return area;
        }

        // Function to render the history table
        function renderHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = ''; // Clear existing rows

            if (liveIncidentsData.size === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">No incidents reported in this session yet.</td></tr>';
                return;
            }

            // Sort incidents by timestamp, most recent first (optional, but good for history)
            const sortedIncidents = Array.from(liveIncidentsData.values()).sort((a, b) => b.timestamp - a.timestamp);

            sortedIncidents.forEach(incident => {
                const row = tableBody.insertRow();
                const messageSnippet = incident.message && incident.message.length > 100 ? incident.message.substring(0, 97) + '...' : incident.message;
                const statusClass = incident.currentStatus === 'active' ? 'status-active' : 'status-resolved';

                row.insertCell().textContent = new Date(incident.timestamp).toLocaleString();
                row.insertCell().textContent = incident.source;
                row.insertCell().textContent = incident.location;
                row.insertCell().textContent = messageSnippet || 'N/A';
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="${statusClass}">${incident.currentStatus.charAt(0).toUpperCase() + incident.currentStatus.slice(1)}</span>`;
            });
        }

        // Function to download history data as CSV
        function downloadHistoryData() {
            if (liveIncidentsData.size === 0) {
                createNotification('Info', 'No history data to download for this session.', 'info');
                return;
            }

            const headers = ['Timestamp', 'Source', 'Location', 'Full Message', 'Status', 'Incident ID', 'Confidence'];
            let csvContent = headers.join(",") + "\r\n";

            const sortedIncidents = Array.from(liveIncidentsData.values()).sort((a, b) => b.timestamp - a.timestamp);

            sortedIncidents.forEach(incident => {
                const timestamp = new Date(incident.timestamp).toLocaleString().replace(/,/g, ';'); // Replace commas in timestamp to avoid CSV issues
                const source = incident.source ? `"${incident.source.replace(/"/g, '""')}"` : 'N/A';
                const location = incident.location ? `"${incident.location.replace(/"/g, '""')}"` : 'N/A';
                const message = incident.message ? `"${incident.message.replace(/"/g, '""')}"` : 'N/A'; // Escape double quotes in message
                const status = incident.currentStatus || 'N/A';
                const id = incident.id || 'N/A';
                const confidence = incident.confidence !== undefined ? incident.confidence + '%' : 'N/A';

                const row = [timestamp, source, location, message, status, id, confidence].join(",");
                csvContent += row + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            const now = new Date();
            const dateString = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            const timeString = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            link.setAttribute("download", `bfp_incident_history_${dateString}_${timeString}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            createNotification('Success', 'Incident history downloaded.', 'success');
        }

        // Attach event listener for download button
        document.addEventListener('DOMContentLoaded', () => {
            const downloadBtn = document.getElementById('downloadHistoryBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadHistoryData);
            }
        });

        // Script to display admin username
        document.addEventListener('DOMContentLoaded', function() {
            const storedUsername = localStorage.getItem('adminUsername');
            if (storedUsername) {
                const usernameElement = document.getElementById('adminUsernameDisplay');
                if (usernameElement) {
                    usernameElement.textContent = storedUsername;
                }
            }
        });

        // Loading screen logic
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (localStorage.getItem('showLoadingScreen') === 'true') {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
                localStorage.removeItem('showLoadingScreen');
                
                // Hide loading screen after a delay
                setTimeout(function() {
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                }, 3000); // 3 seconds delay
            } else {
                 // Ensure it's hidden if the flag isn't set (e.g., direct navigation)
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        });

        // Enhanced checkLoginState function
        function checkLoginState() {
            // Show loading state
            const loginButton = document.querySelector('.fb-login-button');
            if (loginButton) {
                loginButton.classList.add('loading');
            }

            // Check if FB is initialized
            if (typeof FB === 'undefined') {
                console.error('Facebook SDK not loaded');
                createNotification('Error', 'Facebook SDK not loaded. Please refresh the page.', 'error');
                return;
            }

            // Get login status with timeout
            const statusCheck = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Login status check timed out'));
                }, 10000); // 10 second timeout

                FB.getLoginStatus(function(response) {
                    clearTimeout(timeout);
                    resolve(response);
                });
            });

            statusCheck
                .then(response => {
                    // Handle the response
                    statusChangeCallback(response);
                })
                .catch(error => {
                    console.error('Login status check failed:', error);
                    createNotification('Error', 'Failed to check login status. Please try again.', 'error');
                    updateConnectionStatus(false);
                })
                .finally(() => {
                    // Remove loading state
                    if (loginButton) {
                        loginButton.classList.remove('loading');
                    }
                });
        }

        // Add loading state styles
        const style = document.createElement('style');
        style.textContent = `
            .fb-login-button.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            .fb-login-button.loading::after {
                content: '';
                display: inline-block;
                width: 12px;
                height: 12px;
                margin-left: 10px;
                border: 2px solid #fff;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 